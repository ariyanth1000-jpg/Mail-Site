<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Temp Mail</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{
    font-family: Arial, sans-serif;
    background: linear-gradient(180deg,#f7f9ff,#f2f2f2);
    margin:0;
    padding:16px;
  }
  .wrap{
    max-width: 720px;
    margin: 0 auto;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .card{
    background:#fff;
    border-radius:16px;
    padding:16px;
    box-shadow: 0 10px 25px rgba(0,0,0,.08);
  }
  .center{ text-align:center; }
  h2{ margin:6px 0 12px; font-size:22px; }
  .input{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    font-size:15px;
    outline:none;
    box-sizing:border-box;
  }
  .input:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.35); }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    margin-top:10px;
  }
  .row > *{ flex: 1 1 160px; }

  .btn{
    width:100%;
    padding:14px 14px;
    border:0;
    border-radius:14px;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    transition:.15s;
  }
  .btn:active{ transform: scale(.99); }
  .btn-primary{
    background: #2563eb;
    color:#fff;
    box-shadow: 0 10px 18px rgba(37,99,235,.25);
  }
  .btn-ghost{
    background:#eef2ff;
    color:#1e40af;
    border:1px solid #dbeafe;
    font-weight:800;
  }
  .pill{
    display:inline-block;
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    background:#f3f4f6;
    font-weight:800;
    word-break:break-all;
  }
  .muted{ color:#6b7280; font-size:13px; margin-top:8px; }

  .mail{
    border:1px solid #eef2f7;
    padding:10px 12px;
    border-radius:12px;
    margin:10px 0;
    cursor:pointer;
    text-align:left;
  }
  .mail:hover{ background:#fafafa; }
  pre{ white-space:pre-wrap; margin:0; }
</style>
</head>
<body>

<div class="wrap">

  <div class="card center">
    <h2>üìß Temp Mail Inbox</h2>

    <!-- FULL EMAIL BOX -->
    <input id="fullEmail" class="input" placeholder="Full email ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ariyan@domain.com)" />

    <div class="row">
      <button class="btn btn-primary" onclick="useFullEmail()">Use Email</button>
      <button class="btn btn-ghost" onclick="copyEmail()">üìã Copy</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn btn-ghost" onclick="loadInbox()">üîÑ Refresh Inbox</button>
      <button class="btn btn-ghost" onclick="forgetEmail()">üóëÔ∏è Clear</button>
    </div>

    <div class="pill">
      <span id="email">---</span>
    </div>

    <div class="muted" id="status">Full email ‡¶≤‡¶ø‡¶ñ‡ßá ‚ÄúUse Email‚Äù ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®</div>
  </div>

  <div class="card center">
    <h3 style="margin:0 0 10px">üì• Inbox</h3>
    <div id="inbox" class="muted">No mail yet</div>
  </div>

  <div class="card">
    <h3 class="center" style="margin:0 0 10px">üì® Mail View</h3>
    <div id="mail" class="muted center">Select a mail</div>
  </div>

</div>

<script>
const BASE = "https://tinyhost.shop";
let cur = { user:null, domain:null };
let inboxTimer = null;

function setStatus(t){
  document.getElementById("status").innerText = t;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function safeUser(u){
  // allow a-z 0-9 . _ -
  u = (u || "").toLowerCase().trim();
  u = u.replace(/[^a-z0-9._-]/g,"");
  return u.slice(0, 30);
}

function parseFullEmail(email){
  email = String(email || "").trim().toLowerCase();

  // remove spaces
  email = email.replace(/\s+/g, "");

  // basic format
  if(!email.includes("@")) return null;
  const parts = email.split("@");
  if(parts.length !== 2) return null;

  let user = parts[0];
  let domain = parts[1];

  user = safeUser(user);
  if(!user) return null;

  // domain basic check (keep flexible so your 21 domains all work)
  if(!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(domain)) return null;

  return { user, domain, full: `${user}@${domain}` };
}

function startAutoRefresh(){
  if(inboxTimer) clearInterval(inboxTimer);
  inboxTimer = setInterval(() => loadInbox(true), 5000);
}

async function useFullEmail(){
  const raw = document.getElementById("fullEmail").value;
  const parsed = parseFullEmail(raw);

  if(!parsed){
    setStatus("‚ùå ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá email ‡¶¶‡¶ø‡¶®: name@domain.com");
    return;
  }

  cur = { user: parsed.user, domain: parsed.domain };
  document.getElementById("email").innerText = parsed.full;

  // remember so refresh ‡¶¶‡¶ø‡¶≤‡ßá ‡¶π‡¶æ‡¶∞‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
  localStorage.setItem("last_email_full", parsed.full);

  setStatus("‚úÖ Email set. Inbox auto refresh ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
  await loadInbox();
  startAutoRefresh();
}

async function loadInbox(silent=false){
  if(!cur.user || !cur.domain){
    if(!silent) setStatus("‡¶Ü‡¶ó‡ßá email set ‡¶ï‡¶∞‡ßÅ‡¶® (Use Email)");
    return;
  }

  if(!silent) setStatus("Checking inbox...");

  try{
    const url = `${BASE}/api/email/${encodeURIComponent(cur.domain)}/${encodeURIComponent(cur.user)}/?page=1&limit=20`;
    const r = await fetch(url);
    const d = await r.json();

    const mails = d?.data?.emails || d?.emails || d?.data || [];

    const box = document.getElementById("inbox");
    if(!mails.length){
      box.innerHTML = `<div class="muted">No mail yet. Auto refreshing...</div>`;
      if(!silent) setStatus("No mail yet. Auto refreshing...");
      return;
    }

    box.innerHTML = mails.map(m => `
      <div class="mail" onclick="openMail('${(m.id||m.email_id||m._id)}')">
        <div style="font-weight:900">${escapeHtml(m.subject || "No subject")}</div>
        <div class="muted">${escapeHtml(m.from || m.sender || "unknown")}</div>
      </div>
    `).join("");

    if(!silent) setStatus(`‚úÖ Inbox loaded (${mails.length})`);
  }catch(e){
    document.getElementById("inbox").innerHTML = `<div class="muted">Inbox load failed. Domain supported ‡¶®‡¶æ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá / ‡¶®‡ßá‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§</div>`;
    if(!silent) setStatus("‚ùå Inbox load failed");
  }
}

async function openMail(id){
  const mailBox = document.getElementById("mail");
  mailBox.innerHTML = `<div class="muted center">Loading mail...</div>`;

  try{
    const url = `${BASE}/api/email/${encodeURIComponent(cur.domain)}/${encodeURIComponent(cur.user)}/${encodeURIComponent(id)}`;
    const r = await fetch(url);
    const d = await r.json();
    const m = d?.data?.email || d?.email || d;

    const body = m?.body || m?.text || m?.html || "(empty)";

    mailBox.innerHTML = `
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">${escapeHtml(m?.subject || "")}</div>
      <div class="muted" style="margin-bottom:10px"><b>From:</b> ${escapeHtml(m?.from || m?.sender || "")}</div>
      <div style="border:1px solid #eef2f7; border-radius:12px; padding:12px;">
        <pre>${escapeHtml(body)}</pre>
      </div>
    `;
  }catch(e){
    mailBox.innerHTML = `<div class="muted center">Mail open failed</div>`;
  }
}

function copyEmail(){
  const e = document.getElementById("email").innerText;
  if(!e || e === "---") { setStatus("‡¶Ü‡¶ó‡ßá email set ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
  navigator.clipboard.writeText(e);
  setStatus("‚úÖ Copied!");
}

function forgetEmail(){
  localStorage.removeItem("last_email_full");
  cur = { user:null, domain:null };
  document.getElementById("fullEmail").value = "";
  document.getElementById("email").innerText = "---";
  document.getElementById("inbox").innerHTML = `<div class="muted">No mail yet</div>`;
  document.getElementById("mail").innerHTML = `<div class="muted center">Select a mail</div>`;
  setStatus("Cleared. Full email ‡¶¶‡¶ø‡ßü‡ßá Use ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
  if(inboxTimer) clearInterval(inboxTimer);
  inboxTimer = null;
}

// page load: last used email auto restore
(function restoreLast(){
  const saved = localStorage.getItem("last_email_full");
  if(saved){
    document.getElementById("fullEmail").value = saved;
    const parsed = parseFullEmail(saved);
    if(parsed){
      cur = { user: parsed.user, domain: parsed.domain };
      document.getElementById("email").innerText = parsed.full;
      setStatus("‚úÖ Last email loaded. Inbox auto refresh ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
      loadInbox(true);
      startAutoRefresh();
    }
  }
})();

// mobile: tab background ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶≤‡ßá ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
document.addEventListener("visibilitychange", () => {
  if (!document.hidden && cur.user) loadInbox(true);
});
</script>

</body>
</html>
