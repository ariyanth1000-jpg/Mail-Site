<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Trending Academy Mail</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  font-family:Arial, sans-serif;
  background:#f2f4f8;
  margin:0;
  padding:16px;
}
.wrap{
  max-width:720px;
  margin:auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.center{text-align:center}
h2{margin:6px 0 12px}
.input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:15px;
  margin-bottom:8px;
}
.btn{
  width:100%;
  padding:14px;
  border:0;
  border-radius:14px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
.btn-primary{background:#2563eb;color:#fff}
.btn-dark{background:#111827;color:#fff}
.btn-light{background:#eef2ff;color:#1e40af}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.row button{flex:1}
.pill{
  margin-top:10px;
  padding:10px;
  background:#f3f4f6;
  border-radius:12px;
  font-weight:700;
  word-break:break-all;
}
.muted{color:#6b7280;font-size:13px;margin-top:6px}
.mail{
  border:1px solid #eee;
  padding:10px;
  border-radius:12px;
  margin-top:8px;
  cursor:pointer;
}
.mail:hover{background:#fafafa}
pre{white-space:pre-wrap}
</style>
</head>
<body>

<div class="wrap">

<!-- TOP -->
<div class="card center">
<h2>üìß Temp Mail</h2>

<input id="customUser" class="input" placeholder="Custom name (‡¶Ø‡ßá‡¶Æ‡¶®: ariyan)" />

<select id="domainSelect" class="input"></select>
<div class="muted" id="domainStatus">Loading domains...</div>

<div class="row">
<button class="btn btn-primary" onclick="generateEmail(true)">Use Custom Name</button>
<button class="btn btn-dark" onclick="generateEmail(false)">Random Email</button>
</div>

<div class="row" style="margin-top:8px">
<button class="btn btn-light" onclick="copyEmail()">üìã Copy</button>
<button class="btn btn-light" onclick="loadInbox()">üîÑ Refresh</button>
</div>

<div class="pill">
<span id="email">---</span>
</div>

<div class="muted" id="status">Generate ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</div>
</div>

<!-- INBOX -->
<div class="card center">
<h3>üì• Inbox</h3>
<div id="inbox" class="muted">No mail yet</div>
</div>

<!-- MAIL VIEW -->
<div class="card">
<h3 class="center">üì® Mail</h3>
<div id="mail" class="muted center">Select a mail</div>
</div>

</div>

<script>
const BASE="https://tinyhost.shop";
let cur={user:null,domain:null};
let inboxTimer=null;

// utils
function randUser(){
  const c="abcdefghijklmnopqrstuvwxyz0123456789";
  let s="";
  for(let i=0;i<7;i++) s+=c[Math.random()*c.length|0];
  return s;
}
function safeUser(u){
  return (u||"").toLowerCase().replace(/[^a-z0-9._-]/g,"").slice(0,30);
}
function setStatus(t){
  document.getElementById("status").innerText=t;
}

// load domains
async function getDomains(){
  const r=await fetch(BASE+"/api/random-domains/?limit=20");
  const d=await r.json();
  return d.data?.domains||d.domains||d.data||d||[];
}

async function loadDomainsToSelect(){
  try{
    const domains=await getDomains();
    const sel=document.getElementById("domainSelect");
    sel.innerHTML="";
    domains.forEach(d=>{
      const o=document.createElement("option");
      o.value=d; o.textContent=d;
      sel.appendChild(o);
    });
    document.getElementById("domainStatus").innerText=`‚úÖ ${domains.length} domains loaded`;
  }catch(e){
    document.getElementById("domainStatus").innerText="‚ùå Domain load failed";
  }
}

// auto refresh
function startAutoRefresh(){
  if(inboxTimer) clearInterval(inboxTimer);
  inboxTimer=setInterval(()=>loadInbox(true),5000);
}

// generate
async function generateEmail(useCustom){
  try{
    let user,domain;

    if(useCustom){
      user=safeUser(document.getElementById("customUser").value);
      if(!user){ setStatus("Custom name ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"); return; }
      domain=document.getElementById("domainSelect").value;
      if(!domain){ setStatus("Domain select ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
    }else{
      user=randUser();
      const domains=await getDomains();
      domain=domains[Math.random()*domains.length|0];
    }

    cur={user,domain};
    document.getElementById("email").innerText=`${user}@${domain}`;
    setStatus("Email ready. Inbox auto refresh ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
    loadInbox();
    startAutoRefresh();

  }catch(e){
    setStatus("‚ùå Generate failed");
  }
}

// inbox
async function loadInbox(silent=false){
  if(!cur.user) return;
  if(!silent) setStatus("Checking inbox...");
  try{
    const r=await fetch(`${BASE}/api/email/${cur.domain}/${cur.user}/?page=1&limit=20`);
    const d=await r.json();
    const mails=d.data?.emails||d.emails||d.data||[];

    const box=document.getElementById("inbox");
    if(!mails.length){
      box.innerHTML="No mail yet. Auto refreshing...";
      return;
    }

    box.innerHTML=mails.map(m=>`
      <div class="mail" onclick="openMail('${m.id||m.email_id||m._id}')">
      <b>${m.subject||"No subject"}</b><br>
      <small>${m.from||"unknown"}</small>
      </div>
    `).join("");

    if(!silent) setStatus(`Inbox loaded (${mails.length})`);
  }catch(e){
    document.getElementById("inbox").innerText="Inbox load failed";
  }
}

// open mail
async function openMail(id){
  document.getElementById("mail").innerText="Loading...";
  try{
    const r=await fetch(`${BASE}/api/email/${cur.domain}/${cur.user}/${id}`);
    const d=await r.json();
    const m=d.data?.email||d.email||d;
    document.getElementById("mail").innerHTML=`
      <b>${m.subject||""}</b><br>
      <small>${m.from||""}</small><hr>
      <pre>${m.body||m.text||"(empty)"}</pre>
    `;
  }catch(e){
    document.getElementById("mail").innerText="Mail open failed";
  }
}

// copy
function copyEmail(){
  const e=document.getElementById("email").innerText;
  if(!e||e==="---") return;
  navigator.clipboard.writeText(e);
  setStatus("Copied!");
}

// init
loadDomainsToSelect();
document.addEventListener("visibilitychange",()=>{
  if(!document.hidden && cur.user) loadInbox(true);
});
</script>

</body>
</html>
