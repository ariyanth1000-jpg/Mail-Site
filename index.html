<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Temp Mail</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{
    font-family: Arial, sans-serif;
    background: linear-gradient(180deg,#f7f9ff,#f2f2f2);
    margin:0;
    padding:16px;
  }
  .wrap{
    max-width: 720px;
    margin: 0 auto;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .card{
    background:#fff;
    border-radius:16px;
    padding:16px;
    box-shadow: 0 10px 25px rgba(0,0,0,.08);
  }
  .center{
    text-align:center;
  }
  h2{
    margin:6px 0 12px;
    font-size:22px;
  }
  .btn{
    width:100%;
    padding:14px 14px;
    border:0;
    border-radius:14px;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    transition:.15s;
  }
  .btn:active{ transform: scale(.99); }
  .btn-primary{
    background: #2563eb;
    color:#fff;
    box-shadow: 0 10px 18px rgba(37,99,235,.25);
  }
  .btn-secondary{
    background:#111827;
    color:#fff;
  }
  .btn-ghost{
    background:#eef2ff;
    color:#1e40af;
    border:1px solid #dbeafe;
    font-weight:700;
  }
  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
  }
  .row > *{ flex: 1 1 140px; }
  .input{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    font-size:15px;
    outline:none;
  }
  .input:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.35); }
  .pill{
    display:inline-block;
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    background:#f3f4f6;
    font-weight:700;
    word-break:break-all;
  }
  .muted{ color:#6b7280; font-size:13px; margin-top:8px; }
  .mail{
    border:1px solid #eef2f7;
    padding:10px 12px;
    border-radius:12px;
    margin:10px 0;
    cursor:pointer;
  }
  .mail:hover{ background:#fafafa; }
  pre{ white-space:pre-wrap; margin:0; }
</style>
</head>
<body>

<div class="wrap">

  <div class="card center">
    <h2>üìß My Temp Mail</h2>

    <!-- Custom username box -->
    <input id="customUser" class="input" placeholder="Custom name ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ariyan)" />

    <div class="row" style="margin-top:10px">
      <button class="btn btn-primary" onclick="generateEmail(false)">Generate Random Email</button>
      <button class="btn btn-secondary" onclick="generateEmail(true)">Use Custom Name</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn btn-ghost" onclick="copyEmail()">üìã Copy Email</button>
      <button class="btn btn-ghost" onclick="loadInbox()">üîÑ Refresh Inbox</button>
    </div>

    <div class="pill">
      <span id="email">---</span>
    </div>

    <div class="muted" id="status">Generate ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</div>
  </div>

  <div class="card center">
    <h3 style="margin:0 0 10px">üì• Inbox</h3>
    <div id="inbox" class="muted">No mail yet</div>
  </div>

  <div class="card">
    <h3 class="center" style="margin:0 0 10px">üì® Mail View</h3>
    <div id="mail" class="muted center">Select a mail</div>
  </div>

</div>

<script>
const BASE="https://tinyhost.shop";
let cur={user:null,domain:null};
let inboxTimer=null;

function randUser(len=7){
  const c="abcdefghijklmnopqrstuvwxyz0123456789";
  let s="";
  for(let i=0;i<len;i++) s+=c[Math.random()*c.length|0];
  return s;
}

function setStatus(t){
  document.getElementById("status").innerText = t;
}

function safeUser(u){
  // allow a-z 0-9 . _ -
  u = (u||"").toLowerCase().trim();
  u = u.replace(/[^a-z0-9._-]/g,"");
  return u.slice(0,30);
}

async function getDomains(){
  const r=await fetch(BASE+"/api/random-domains/?limit=10");
  const d=await r.json();
  return d.data?.domains||d.domains||d.data||d||[];
}

function startAutoRefresh(){
  if(inboxTimer) clearInterval(inboxTimer);
  inboxTimer = setInterval(()=>loadInbox(true), 5000);
}

async function generateEmail(useCustom){
  try{
    setStatus("Loading domains...");
    const domains = await getDomains();
    const domain = domains[Math.random()*domains.length|0];

    let user;
    if(useCustom){
      user = safeUser(document.getElementById("customUser").value);
      if(!user){
        setStatus("Custom name ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (a-z / 0-9) ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ Use Custom Name ‡¶¶‡¶ø‡¶®");
        return;
      }
    }else{
      user = randUser();
    }

    cur = { user, domain };
    document.getElementById("email").innerText = `${user}@${domain}`;
    setStatus("‚úÖ Email ready. Inbox auto refresh ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
    await loadInbox();
    startAutoRefresh();

  }catch(e){
    setStatus("‚ùå Domain load failed. ‡¶®‡ßá‡¶ü/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");
  }
}

async function loadInbox(silent=false){
  if(!cur.user) {
    if(!silent) setStatus("‡¶Ü‡¶ó‡ßá Generate Email ‡¶¶‡¶ø‡¶®");
    return;
  }
  if(!silent) setStatus("Checking inbox...");
  try{
    const r=await fetch(`${BASE}/api/email/${encodeURIComponent(cur.domain)}/${encodeURIComponent(cur.user)}/?page=1&limit=20`);
    const d=await r.json();
    const mails=d.data?.emails||d.emails||d.data||[];

    const box=document.getElementById("inbox");
    if(!mails.length){
      box.innerHTML = `<div class="muted">No mail yet. Auto refreshing...</div>`;
      if(!silent) setStatus("No mail yet. Auto refreshing...");
      return;
    }

    box.innerHTML = mails.map(m=>`
      <div class="mail" onclick="openMail('${(m.id||m.email_id||m._id)}')">
        <div style="font-weight:800">${escapeHtml(m.subject||"No subject")}</div>
        <div class="muted">${escapeHtml(m.from||m.sender||"unknown")}</div>
      </div>
    `).join("");

    if(!silent) setStatus(`‚úÖ Inbox loaded (${mails.length})`);
  }catch(e){
    document.getElementById("inbox").innerHTML = `<div class="muted">Inbox load failed. ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>`;
    if(!silent) setStatus("‚ùå Inbox load failed");
  }
}

async function openMail(id){
  const mailBox = document.getElementById("mail");
  mailBox.className = "";
  mailBox.innerHTML = `<div class="muted center">Loading mail...</div>`;
  try{
    const r=await fetch(`${BASE}/api/email/${encodeURIComponent(cur.domain)}/${encodeURIComponent(cur.user)}/${encodeURIComponent(id)}`);
    const d=await r.json();
    const m=d.data?.email||d.email||d;

    const body = m.body || m.text || m.html || "(empty)";
    mailBox.innerHTML = `
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">${escapeHtml(m.subject||"")}</div>
      <div class="muted" style="margin-bottom:10px"><b>From:</b> ${escapeHtml(m.from||m.sender||"")}</div>
      <div class="card" style="box-shadow:none;border:1px solid #eef2f7">
        <pre>${escapeHtml(body)}</pre>
      </div>
    `;
  }catch(e){
    mailBox.innerHTML = `<div class="muted center">Mail open failed</div>`;
  }
}

function copyEmail(){
  const e=document.getElementById("email").innerText;
  if(!e || e==="---") { setStatus("‡¶Ü‡¶ó‡ßá Generate Email ‡¶¶‡¶ø‡¶®"); return; }
  navigator.clipboard.writeText(e);
  setStatus("‚úÖ Copied!");
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// mobile ‡¶è background ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ refresh ‡¶∂‡ßÅ‡¶∞‡ßÅ
document.addEventListener("visibilitychange", () => {
  if (!document.hidden && cur.user) loadInbox(true);
});
</script>

</body>
</html>
